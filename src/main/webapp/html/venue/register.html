<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Bootstrap 101 Template</title>

    <!-- Normalize -->
    <link href="../../css/normalize.css" rel="stylesheet">
    <!-- Bootstrap -->
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <!-- seat css -->
    <link href="../../css/seat.css" rel="stylesheet">

    <style>
        #all-venue-info {
            padding-top: 2%;
            margin-top: 2%;
            border-top: #adadad solid 1px;
        }

        #legend-info {
            margin-top: 3%;
        }

        /*
        增加删除按钮组的上下间距
        */
        #add-delete-container {
            margin-top: 20%;
            margin-bottom: 20%;
        }

        #venue-basic-info-form {
            margin-top: 30%;
        }

    </style>

</head>
<body>

<!-- nav begin -->
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <!-- 导航栏头 -->
        <div class="navbar-header">
            <a class="navbar-brand" href="#">小麦网</a>
        </div>
    </div>
</nav>
<!-- nav end -->

<!-- container begin -->
<div id="venue-register-container" class="container">
    <div class="row">
        <h2 class="text-center">场馆注册</h2>
    </div>
    <div id="all-venue-info" class="row">
        <div id="legend-info" class="col-md-2">
            <div id="legend-container">
                <div id="legend-box"></div>
            </div>
            <div id="seat-operation-container">
                <div id="add-delete-container">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" id="add-row">增加一行</button>
                        <button type="button" class="btn btn-primary" id="add-column">增加一列</button>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-warning" id="delete-row">删除一行</button>
                        <button type="button" class="btn btn-warning" id="delete-column">删除一列</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div id="seat-map-container" class="text-center">
                <div class="front-indicator">Front</div>
                <div id="seat-map"></div>
            </div>
        </div>
        <div class="col-md-2">
            <form id="venue-basic-info-form">
                <div class="form-group">
                    <label class="control-label">场馆名</label>
                    <input id="venue-name" type="text" class="form-control">
                </div>
                <div class="form-group">
                    <label class="control-label">密码</label>
                    <input id="venue-password" type="password" class="form-control">
                </div>
                <div class="form-group">
                    <label class="control-label">确认密码</label>
                    <input id="venue-password-confirm" type="password" class="form-control">
                </div>
                <div class="form-group">
                    <label class="control-label">城市</label>
                    <select id="venue-city" class="form-control">
                        <option>北京</option>
                        <option>上海</option>
                        <option>重庆</option>
                        <option>南京</option>
                    </select>
                </div>
                <button id="venue-register-btn" type="button" class="btn btn-primary center-block">注册</button>
            </form>
        </div>
    </div>
</div>
<!-- container end -->

<!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
<script src="../../js/jquery-3.3.1.min.js"></script>
<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="../../js/bootstrap.min.js"></script>
<!-- seat js -->
<script src="../../js/jquery.seat-charts.min.js"></script>

<script>

    /**
     * 保存座位图
     * @type {string[]} todo 从服务器接收数据
     */
    let seatMap = [
        'aaaaaaaaaaaaaaa',
        'aaaaaaaaaaaaaaa',
        'aaaaaaaaaaaaaaa'
    ];

    /**
     * 保存座位信息
     * @type {{a: {classes: string}}} todo 从服务器接收数据
     */
    let seatInfo = {
        a: {
            //Custom CSS classes which should be applied to seats.
            //'seat-red seat-big' or ['seat-red', 'seat-big']
            //点击座位，转换为空位
            click: seat2space,
            classes: 'default-seat'
        }
    };

    /**
     * 座位图例
     * @type {{node: *|jQuery|HTMLElement, items: *[]}}
     */
    let legendInfo = {
        //jQuery reference to a DIV element where legend should be rendered.
        node: $('#legend-box'),
        //An array of legend item details. Each array element should be a three-element array: [ character, status, description ]
        items: [
            ['a', 'available', '有座位', '/']
        ]
    };

    /**
     * 添加一行
     */
    function add_row() {
        if (seatMap.length === 15) {
            alert("座位行数不可以大于15");
        }
        else {
            //新建一行，长度与当前座位图中每一行的长度相等
            let rowLength = seatMap[0].length;
            let newRow = [];
            for (let i = 0; i < rowLength; i++) {
                newRow.push('a');
            }
            seatMap.push(newRow.join(""));
            rerender();
        }
    }

    /**
     * 增加一列
     */
    function add_column() {
        if (seatMap[0].length === 20) {
            alert("座位列数不可以大于20");
        }
        else {
            $.each(seatMap, function (index, val) {
                seatMap[index] = val + 'a';
            });
            rerender();
        }
    }

    //删除一行
    function delete_row() {
        if (seatMap.length === 3) {
            alert("座位行数不可以小于3");
        }
        else {
            seatMap.pop();
        }
        rerender();
    }

    //删除一列
    function delete_column() {
        if (seatMap[0].length === 10) {
            alert("座位列数不可以小于10");
        }
        else {
            $.each(seatMap, function (index, val) {
                seatMap[index] = val.substring(0, val.length - 1);
            });
            rerender();
        }
    }

    /**
     * 将座位设置为空
     */
    function seat2space() {
        let thisId = this.node().attr("id");
        let rowAndColumn = thisId.split("_");
        let row = rowAndColumn[0];
        let column = rowAndColumn[1];

        let row_info = seatMap[row - 1].split("");
        row_info[column - 1] = '_';

        seatMap[row - 1] = row_info.join("");
        rerender();
    }

    /**
     * 将空位设置为座位
     */
    function space2seat() {
        let row = $(this).parent().prevAll().length + 1;
        let column = $(this).prevAll().length;

        let row_info = seatMap[row - 1].split("");
        row_info[column - 1] = 'a';

        seatMap[row - 1] = row_info.join("");
        rerender();
    }

    /**
     * 渲染座位
     */
    function renderSeats() {
        $("#seat-map").seatCharts({
            //必须的
            //每个字符表示一个座位，下划线表示没有座位
            //每一行的列数必须相等
            map: seatMap,
            seats: seatInfo,
            naming: {
                top: false,
                //默认getId函数
                getId: function (character, row, column) {
                    return row + '_' + column;
                },
                //默认getLabel函数
                //Labels will be displayed over seats
                //so if you don't want any labels, just return an empty string.
                getLabel: function (character, row, column) {
                    return character;
                }
            },
            //legend
            legend: legendInfo,
            click: function () {
                if (this.status() === 'available') {
                    return 'available';
                } else {
                    if (this.char() === '_') {
                        alert(this.status() + "\n" + this.node() + "\n" + this.data() + "\n" + this.char());
                    }
                    // return this.style();
                }
            }
        });
    }

    /**
     * 重新渲染座位
     */
    function rerender() {
        //删除原来的seat-map div
        $("#seat-map").remove();
        //删除座位类型的list
        $(".seatCharts-legendList").remove();
        //添加新的seat-map元素
        let newSeatMap = "<div id='seat-map'></div>";
        //将新的seat-map元素添加到外层container中
        $("#seat-map-container").append(newSeatMap);
        //重新渲染座位图
        renderSeats();
    }

    $(document).ready(function () {

        renderSeats();

        $("#add-row").on("click", add_row);
        $("#add-column").on("click", add_column);
        $("#delete-row").on("click", delete_row);
        $("#delete-column").on("click", delete_column);

        //空位添加由空位转换到座位的点击事件
        $("#seat-map-container").on("click", ".seatCharts-space:empty", space2seat);

        $("#venue-register-btn").on("click", function () {
            let seatMapArr = [];
            $.each(seatMap, function (row, str) {
                $.each(str.split(""), function (column, char) {
                    let newVenueSeat = {
                        "venueSeatId": {
                            "row": row+1,
                            "column": column+1
                        },
                        "hasSeat": char === 'a'
                    };
                    seatMapArr.push(newVenueSeat);
                });
            });

            let venue = {
                "name": $("#venue-name").val(),
                "city": $("#venue-city").val(),
                "password": $("#venue-password").val(),
                "rowNum": seatMap.length,
                "columnNum": seatMap[0].length,
                "seatMap": seatMapArr
            };

            console.log(JSON.stringify(venue));
        });
    });
</script>
</body>
</html>